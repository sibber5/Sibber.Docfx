# Sibber.Docfx

This repo has the docfx config that I use for my library docs sites. It uses `fuse.js` in place of `lunr.js`, and the `ExtractSearchIndexEx` post processor which I [forked from the docfx repo](https://github.com/dotnet/docfx/blob/44383167ece82d4deb7c2062de1a2e34b32607e9/src/Docfx.Build/PostProcessors/ExtractSearchIndex.cs) and modified to index all (configurable) public members of types in addition to the types themselves.

It also includes a Github Actions [deployment workflow](./github_actions/deploy-docfx-to-github-pages.yaml), which builds the docfx API metadata and site, and then configures GitHub Pages and deploys to it. See [section in Usage](#github-actions-deployment-workflow) for more details.

# Usage

> [!IMPORTANT]  
> Make sure `build.postProcessors` in `docfx.json` contains `ExtractSearchIndex` before `ExtractSearchIndexEx`.\
`ExtractSearchIndex` cannot be disabled without disabling search, so `ExtractSearchIndexEx` assumes `ExtractSearchIndex` has already run and that `index.json` already exists as a resource in the manifest and overwrites it. If `ExtractSearchIndex` does not run before `ExtractSearchIndexEx` then the `index.json` generated by `ExtractSearchIndexEx` will be overwritten.

1. Clone the repository
2. Replace `"mysite"` in [`./docfx/docfx.json`](./docfx/docfx.json) with site name
3. Fill in the urls in [`./docfx/templates/custom_template/public/main.js`](./docfx/templates/custom_template/public/main.js)
4. Add `favicon.ico` and `icon.svg` to [`./docfx/images/`](./docfx/images/)
5. Run [`publish_plugins.bat`](./publish_plugins.bat)
6. [Optional] Configure `fuse.js` options in [`public/search-worker.min.js`](./docfx/templates/modern/public/search-worker.min.js)
7. Copy the `docfx` folder to your repository and rename it to whatever you want

## ExtractSearchIndexEx

The `ExtractSearchIndexEx` post processor has 2 additional configuration options (set in `globalMetadata` in `docfx.json`):
 - `"_searchIndexStripSiteNameFromTitle": bool` (default: `false`) specifies whether to remove the site name from the search result titels, e.g. `Class SomeNamespace.SomeClass | SiteName` becomes `Class SomeNamespace.SomeClass`. *This only has an effect if `_searchIndexUseMetadataTitle` is set to `false` (or `_searchIndexUseMetadata` is `false`), or if the title metadata does not exist.*
 - `"_searchIndexScopes": string[]` (default: `["All"]`) specifies what to be indexed. The possible values are the defined enum values in [`SearchScopes`](./ExtractSearchIndexEx/SearchScopes.cs). e.g. `["Types", "Methods"]`. `["Types"]` would index the same symbols as the built in `ExtractSearchIndex`.

## Github Actions deployment workflow

The [deployment workflow](./github_actions/deploy-docfx-to-github-pages.yaml) requires GitHub Pages 'Build and deployment' source to be set to 'GitHub Actions' (in the GitHub repository settings, under 'Pages').

It is triggered when a tag that matches `v[0-9]+.[0-9]+*` is pushed.  
If you also only want to trigger when the tag is pushed to `main` (or a specific branch), the recommended approach is to set an environment protection rule (in the GitHub repo settings, under 'Environments/github-pages') to only allow deployments from the specific branch; However if this is not enough for your usecase then you can uncomment the condition for the `build-documentation` job, but make sure to read the warning there.

#### Other defaults you may want to change:
 - `docfx.json` path: by default assumes it is in the `docs/` folder in the root of your repo.
 - .NET SDK version: by default uses `8.x`, which is the minimum required by docfx.

# Notes

## `modern` template

The `modern` template is just the normal docfx (compiled) modern template exported with `docfx template export modern` with the following changes:
 - [`public/search-worker.min.js`](./docfx/templates/modern/public/search-worker.min.js): replaced with fuse.js impl https://gist.github.com/filzrev/9a046c40f6df63d01f40018d8a19bd47 and modified
 - `public/search-worker.min.js.map`: deleted
 - [`public/docfx.min.js`](/docfx/templates/modern/public/docfx.min.js):
    - Line 17, removed `+"?q="+It` (search query from redirect url when clicking on a search result) so that fragment identifiers work
    - Line 15, removed `let{lunrLanguages:e}=await D();i.postMessage({init:{lunrLanguages:e}});`
    - Line 6, removed `, "lunrLanguages"`
 - `public/docfx.min.js.map`:
    - Line 4, removed corresponding ` + '?q=' + query`
    - Line 4, removed corresponsing `const { lunrLanguages } = await options()\n  worker.postMessage({ init: { lunrLanguages } })\n\n  `
 - Deleted unused lunr files:
    - `public/chunk-DTUU2GN4.min.js` and `public/chunk-DTUU2GN4.min.js.map` (lunr japanese, not sure why its not named lunr.ja like the other localization files)
    - All files in [`public/`](/docfx/templates/modern/public/) that being with `lunr`

# License

The file [`./ExtractSearchIndexEx/ExtractSearchIndexEx.cs`](./ExtractSearchIndexEx/ExtractSearchIndexEx.cs) was taken from [`Docfx.Build`, github.com/dotnet/docfx](https://github.com/dotnet/docfx/blob/44383167ece82d4deb7c2062de1a2e34b32607e9/src/Docfx.Build/PostProcessors/ExtractSearchIndex.cs), MIT License - Copyright (c) .NET Foundation and Contributors. See the license notice at the top of the file for more info.

The rest of the [`ExtractSearchIndexEx`](./ExtractSearchIndexEx/) plugin and modifications to the file mentioned above are licensed under the MIT License - see [`LICENSE`](./LICENSE) - unless otherwise stated in specific files or sections. See individual files for exceptions.

All files that are not in [`ExtractSearchIndexEx/`](./ExtractSearchIndexEx/) and not in [`docfx/`](./docfx/), and the files that *are* in [`docfx/templates/customizations/`](./docfx/templates/customizations/), are licensed under the MIT License - see [`LICENSE`](./LICENSE) - unless otherwise stated in specific files or sections.
